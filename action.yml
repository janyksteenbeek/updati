name: 'Updati - Dependency Updater'
description: 'Automatically update dependencies across multiple repositories'
author: '@janyksteenbeek'

branding:
  icon: 'refresh-cw'
  color: 'orange'

inputs:
  github_token:
    description: 'GitHub token with repo access'
    required: true
  owner:
    description: 'GitHub owner (user or organization) to scan for repositories'
    required: true
  repo_patterns:
    description: 'Regex patterns to match repository names (one per line)'
    required: false
    default: '.*'
  workers:
    description: 'Number of concurrent workers'
    required: false
    default: '5'
  base_branch:
    description: 'Base branch to create PRs against'
    required: false
    default: 'main'
  create_pr:
    description: 'Create pull requests instead of direct push'
    required: false
    default: 'true'
  dry_run:
    description: 'Perform a dry run without making changes'
    required: false
    default: 'false'
  update_composer:
    description: 'Update Composer dependencies'
    required: false
    default: 'true'
  update_npm:
    description: 'Update NPM dependencies'
    required: false
    default: 'true'

outputs:
  total:
    description: 'Total number of repositories processed'
  updated:
    description: 'Number of repositories updated'
  failed:
    description: 'Number of repositories that failed to update'

runs:
  using: 'composite'
  steps:
    - name: Run Updati
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
        UPDATI_OWNER: ${{ inputs.owner }}
        UPDATI_REPO_PATTERNS: ${{ inputs.repo_patterns }}
        UPDATI_WORKERS: ${{ inputs.workers }}
        UPDATI_BASE_BRANCH: ${{ inputs.base_branch }}
        UPDATI_CREATE_PR: ${{ inputs.create_pr }}
        UPDATI_DRY_RUN: ${{ inputs.dry_run }}
        UPDATI_UPDATE_COMPOSER: ${{ inputs.update_composer }}
        UPDATI_UPDATE_NPM: ${{ inputs.update_npm }}
      run: |
        docker run --rm \
          -e GITHUB_TOKEN \
          -e UPDATI_OWNER \
          -e UPDATI_REPO_PATTERNS \
          -e UPDATI_WORKERS \
          -e UPDATI_BASE_BRANCH \
          -e UPDATI_CREATE_PR \
          -e UPDATI_DRY_RUN \
          -e UPDATI_UPDATE_COMPOSER \
          -e UPDATI_UPDATE_NPM \
          ghcr.io/janyksteenbeek/updati:latest
